import telebot
from telebot.types import ChatPermissions
import requests
import random
import os
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from datetime import datetime, timedelta, date
import time
import atexit
from telebot import TeleBot, types
import pytz
import threading
from threading import Timer
import json
import re
import traceback
import schedule
from telebot.apihelper import ApiException
from collections import defaultdict
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger

# =====================--------------(TOKEN BOT)--------------=====================
# THAY TH·∫æ C√ÅC TOKEN N√ÄY B·∫∞NG TOKEN TH·ª∞C T·∫æ C·ª¶A B·∫†N
API_BOT = '7324552224:AAGcEd3dg5OZuIs0bJF6QFfa4B3lgNq2rh8' # Bot ch√≠nh (d√πng cho l·ªánh /congtien v√† th√¥ng b√°o ri√™ng cho admin)
API_BOT2 = '7975395053:AAE6xhLQ-y6BJTlvrNgWjOOWSnZMZ40AxTw' # Bot ph√≤ng game T√†i X·ªâu
API_BOT3 = '8027877843:AAG1z9OcCkdz8jcT3KnWuKi6BCZvlJhxu2s' # Bot th√¥ng b√°o (c√≥ th·ªÉ kh√¥ng c·∫ßn n·∫øu ch·ªâ g·ª≠i ri√™ng admin)

bot = telebot.TeleBot(API_BOT) # parse_mode=None l√† m·∫∑c ƒë·ªãnh, c√≥ th·ªÉ b·ªè
bot2 = telebot.TeleBot(API_BOT2)
bot3 = telebot.TeleBot(API_BOT3) # Gi·ªØ l·∫°i n·∫øu b·∫°n mu·ªën bot3 v·∫´n g·ª≠i th√¥ng b√°o c√¥ng khai

# =====================--------------(C·∫•u h√¨nh Admin v√† Nh√≥m)--------------=====================
ADMIN_ID = 6915752059 # THAY TH·∫æ B·∫∞NG ID TELEGRAM C·ª¶A ADMIN
# D∆∞·ªõi ƒë√¢y l√† c√°c ID nh√≥m chat. M√¨nh ƒë·∫∑t ch√∫ng gi·ªëng nhau d·ª±a tr√™n v√≠ d·ª• c·ªßa b·∫°n.
# N·∫øu b·∫°n c√≥ c√°c nh√≥m kh√°c nhau, h√£y thay ƒë·ªïi ID cho ph√π h·ª£p.
GAME_ROOM_ID = -1002781947864 # ID nh√≥m ph√≤ng game T√†i X·ªâu
RESULT_CHANNEL_ID = -1002781947864 # ID nh√≥m th√¥ng b√°o k·∫øt qu·∫£ ph√≤ng game (c√≥ th·ªÉ l√† k√™nh ho·∫∑c nh√≥m kh√°c)

# =====================--------------(Bi·∫øn to√†n c·ª•c)--------------=====================
user_balance = {}
user_bets = {} # L∆∞u tr·ªØ c∆∞·ª£c c·ªßa ng∆∞·ªùi ch∆°i trong phi√™n hi·ªán t·∫°i
current_session = 1
session_results = [] # L·ªãch s·ª≠ k·∫øt qu·∫£ c√°c phi√™n (ch·ªâ gi·ªØ 10 phi√™n g·∫ßn nh·∫•t)
processed_users = set() # Theo d√µi ng∆∞·ªùi ch∆°i ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω th·∫Øng/thua trong phi√™n
accepting_bets = False # Tr·∫°ng th√°i cho ph√©p ƒë·∫∑t c∆∞·ª£c

# =====================--------------(Kho L∆∞u S·ªë D∆∞)--------------=====================

def save_balance_to_file():
    """L∆∞u s·ªë d∆∞ c·ªßa ng∆∞·ªùi d√πng v√†o file sodu.txt"""
    with open("sodu.txt", "w") as f:
        for user_id, balance in user_balance.items():
            f.write(f"{user_id} {int(balance)}\n") # L∆∞u d∆∞·ªõi d·∫°ng s·ªë nguy√™n

def load_balance_from_file():
    """T·∫£i s·ªë d∆∞ c·ªßa ng∆∞·ªùi d√πng t·ª´ file sodu.txt"""
    if os.path.exists("sodu.txt"):
        with open("sodu.txt", "r") as f:
            for line in f:
                if line.strip():
                    try:
                        user_id, balance_str = line.strip().split()
                        user_balance[int(user_id)] = int(float(balance_str)) # ƒê·∫£m b·∫£o l√† s·ªë nguy√™n
                    except ValueError:
                        print(f"L·ªói ƒë·ªçc d√≤ng trong sodu.txt: {line.strip()}")
    else:
        open("sodu.txt", "a").close() # T·∫°o file n·∫øu ch∆∞a t·ªìn t·∫°i

# T·∫£i s·ªë d∆∞ khi bot kh·ªüi ƒë·ªông
load_balance_from_file()

# ƒêƒÉng k√Ω h√†m save_balance_to_file ƒë·ªÉ ch·∫°y khi script k·∫øt th√∫c
atexit.register(save_balance_to_file)

# =====================--------------(Qu·∫£n l√Ω Phi√™n Game)--------------=====================

def save_session_to_file():
    """L∆∞u s·ªë phi√™n hi·ªán t·∫°i v√†o file phien.txt"""
    with open("phien.txt", "w") as file:
        file.write(str(current_session))

def load_session_from_file():
    """T·∫£i s·ªë phi√™n hi·ªán t·∫°i t·ª´ file phien.txt"""
    global current_session
    try:
        with open("phien.txt", "r") as file:
            current_session = int(file.read().strip())
    except FileNotFoundError:
        current_session = 1
        save_session_to_file() # T·∫°o file n·∫øu ch∆∞a c√≥
    except ValueError:
        current_session = 1 # Reset n·∫øu n·ªôi dung file kh√¥ng h·ª£p l·ªá
        save_session_to_file()

def save_session_history_to_file():
    """L∆∞u l·ªãch s·ª≠ 10 phi√™n g·∫ßn nh·∫•t v√†o file matphien.txt"""
    last_10_sessions = session_results[-10:]
    display_last_10 = " ".join(
        ["üîµ" if session == 'T' else "üî¥" for session in last_10_sessions])
    with open("matphien.txt", "w", encoding='utf-8') as file:
        file.write(display_last_10)

def load_session_history_from_file():
    """T·∫£i l·ªãch s·ª≠ phi√™n t·ª´ file matphien.txt"""
    global session_results
    try:
        if os.path.exists("matphien.txt"):
            with open("matphien.txt", "r", encoding='utf-8') as file:
                session_history_str = file.read().strip()
                if session_history_str:
                    session_history = session_history_str.split()
                    session_results = [
                        'T' if session == 'üîµ' else 'X'
                        for session in session_history
                    ]
                else:
                    session_results = []
        else:
            session_results = []
            save_session_history_to_file() # T·∫°o file n·∫øu ch∆∞a c√≥
    except Exception as e:
        print(f"L·ªói khi t·∫£i l·ªãch s·ª≠ phi√™n: {e}")
        session_results = [] # ƒê·∫£m b·∫£o session_results l√† m·ªôt list r·ªóng n·∫øu c√≥ l·ªói

# T·∫£i d·ªØ li·ªáu phi√™n khi bot kh·ªüi ƒë·ªông
load_session_from_file()
load_session_history_from_file()

# =====================--------------(H√†m h·ªó tr·ª£ Game)--------------=====================

def send_dice_room_reply(chat_id):
    """G·ª≠i x√∫c x·∫Øc v√† tr·∫£ v·ªÅ gi√° tr·ªã"""
    try:
        # S·ª≠ d·ª•ng bot2 ƒë·ªÉ g·ª≠i x√∫c x·∫Øc trong ph√≤ng game
        message = bot2.send_dice(chat_id=chat_id, emoji="üé≤")
        return message.dice.value
    except ApiException as e:
        print(f"L·ªói API khi g·ª≠i x√∫c x·∫Øc: {e}")
        return None
    except Exception as e:
        print(f"L·ªói kh√¥ng x√°c ƒë·ªãnh khi g·ª≠i x√∫c x·∫Øc: {e}")
        return None

def check_result(dice_sum):
    """Ki·ªÉm tra k·∫øt qu·∫£ T√†i/X·ªâu t·ª´ t·ªïng ƒëi·ªÉm x√∫c x·∫Øc"""
    if 11 <= dice_sum <= 18:
        return 'T' # T√†i
    elif 3 <= dice_sum <= 10:
        return 'X' # X·ªâu
    return 'None' # Tr∆∞·ªùng h·ª£p kh√¥ng th·ªÉ x·∫£y ra v·ªõi 3 x√∫c x·∫Øc

def check_result_text(dice_sum):
    """Tr·∫£ v·ªÅ chu·ªói 'T√ÄI' ho·∫∑c 'X·ªàU'"""
    if 11 <= dice_sum <= 18:
        return 'T√ÄI'
    elif 3 <= dice_sum <= 10:
        return 'X·ªàU'
    return 'Kh√¥ng x√°c ƒë·ªãnh'

def confirm_bet(user_id, bet_type, bet_amount, original_message_id, is_anonymous=False):
    """X√°c nh·∫≠n v√† x·ª≠ l√Ω ƒë·∫∑t c∆∞·ª£c c·ªßa ng∆∞·ªùi ch∆°i"""
    global current_session
    global user_balance

    if user_balance.get(user_id, 0) >= bet_amount:
        if user_id not in user_bets:
            user_bets[user_id] = {'T': 0, 'X': 0}

        # Ki·ªÉm tra xem ng∆∞·ªùi ch∆°i ƒë√£ c∆∞·ª£c m·∫∑t ƒë·ªëi di·ªán ch∆∞a
        opposite_bet_type = 'T' if bet_type.upper() == 'X' else 'X'
        if user_bets[user_id][opposite_bet_type] > 0:
            try:
                bot2.send_message(GAME_ROOM_ID, "‚ùå Kh√¥ng ƒë∆∞·ª£c c∆∞·ª£c c·∫£ hai b√™n trong m·ªôt phi√™n.", reply_to_message_id=original_message_id)
            except ApiException as e:
                print(f"L·ªói g·ª≠i tin nh·∫Øn ƒë·∫øn nh√≥m: {e}")
            return False

        user_bets[user_id][bet_type.upper()] += bet_amount
        user_balance[user_id] -= bet_amount
        save_balance_to_file()

        encoded_user_id = f"***{str(user_id)[-4:]}"
        remaining_balance = user_balance[user_id]

        if is_anonymous:
            confirmation_message = f"üèÆ **ƒê·∫∑t th√†nh c√¥ng k·ª≥ XX #`{current_session}`\nL·ªánh {bet_type}\nS·ªë ti·ªÅn c∆∞·ª£c: `{int(bet_amount):,}`\nNg∆∞·ªùi c∆∞·ª£c: `(·∫®n Danh)`**"
            bot2.send_message(GAME_ROOM_ID, confirmation_message, parse_mode='Markdown')
        else:
            confirmation_message = f"üèÆ **ƒê·∫∑t th√†nh c√¥ng k·ª≥ #`{current_session}`\nL·ªánh {bet_type}\nS·ªë ti·ªÅn c∆∞·ª£c: `{int(bet_amount):,}`\nNg∆∞·ªùi c∆∞·ª£c: `({encoded_user_id})`**"
            bot2.send_message(GAME_ROOM_ID, confirmation_message, reply_to_message_id=original_message_id, parse_mode='Markdown')

        confirmation_message1 = f"üèÆ **B·∫°n ƒë·∫∑t th√†nh c√¥ng k·ª≥ XX #`{current_session}`\nL·ªánh: {bet_type} - {int(bet_amount):,}\nS·ªë d∆∞ c√≤n l·∫°i: {int(remaining_balance):,}**"
        try:
            bot.send_message(chat_id=user_id, text=confirmation_message1, parse_mode='Markdown')
        except ApiException as e:
            print(f"Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn x√°c nh·∫≠n cho ng∆∞·ªùi d√πng {user_id}: {e}")

        return True
    else:
        if is_anonymous:
            encoded_user_id = f"(·∫®n Danh)"
            bot2.send_message(GAME_ROOM_ID, f"‚ùå {encoded_user_id} Kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ ƒë·∫∑t c∆∞·ª£c.")
        else:
            encoded_user_id = f"***{str(user_id)[-4:]}"
            bot2.send_message(GAME_ROOM_ID, f"‚ùå {encoded_user_id} Kh√¥ng ƒë·ªß s·ªë d∆∞ ƒë·ªÉ ƒë·∫∑t c∆∞·ª£c.", reply_to_message_id=original_message_id)
        return False

def calculate_user_winnings(user_id, game_result):
    """T√≠nh to√°n ti·ªÅn th·∫Øng cho ng∆∞·ªùi ch∆°i"""
    winnings = 0
    if user_id in user_bets:
        if game_result == 'T' and user_bets[user_id]['T'] > 0:
            winnings = 1.95 * user_bets[user_id]['T']
        elif game_result == 'X' and user_bets[user_id]['X'] > 0:
            winnings = 1.95 * user_bets[user_id]['X']
    user_balance[user_id] = user_balance.get(user_id, 0) + winnings
    return winnings

def calculate_user_losses(user_id, game_result):
    """T√≠nh to√°n ti·ªÅn thua cho ng∆∞·ªùi ch∆°i"""
    losses = 0
    if user_id in user_bets:
        if game_result == 'T' and user_bets[user_id]['X'] > 0: # C∆∞·ª£c X thua n·∫øu ra T
            losses = user_bets[user_id]['X']
        elif game_result == 'X' and user_bets[user_id]['T'] > 0: # C∆∞·ª£c T thua n·∫øu ra X
            losses = user_bets[user_id]['T']
    return losses

def turn_on_group_chat():
    """B·∫≠t quy·ªÅn g·ª≠i tin nh·∫Øn trong nh√≥m game"""
    permissions = ChatPermissions(can_send_messages=True)
    try:
        bot2.set_chat_permissions(GAME_ROOM_ID, permissions)
    except ApiException as e:
        print(f"L·ªói khi b·∫≠t quy·ªÅn nh·∫Øn tin: {e}")

def turn_off_group_chat():
    """T·∫Øt quy·ªÅn g·ª≠i tin nh·∫Øn trong nh√≥m game"""
    permissions = ChatPermissions(can_send_messages=False)
    try:
        bot2.set_chat_permissions(GAME_ROOM_ID, permissions)
    except ApiException as e:
        print(f"L·ªói khi t·∫Øt quy·ªÅn nh·∫Øn tin: {e}")

# =====================--------------(Lu·ªìng Game)--------------=====================

def start_game():
    """B·∫Øt ƒë·∫ßu m·ªôt phi√™n game m·ªõi"""
    global current_session, accepting_bets, user_bets, processed_users
    
    # Reset d·ªØ li·ªáu cho phi√™n m·ªõi
    user_bets.clear()
    processed_users.clear()

    current_session += 1
    save_session_to_file() # L∆∞u s·ªë phi√™n ngay l·∫≠p t·ª©c

    accepting_bets = True

    turn_on_group_chat()
    
    # G·ª≠i th√¥ng b√°o b·∫Øt ƒë·∫ßu phi√™n c∆∞·ª£c
    try:
        bot2.send_message(
            GAME_ROOM_ID,
            f"<blockquote> M·ªùi B·∫°n ƒê·∫∑t C∆∞·ª£c Phi√™n #`{current_session}`</blockquote>\n\n"
            f"‚óâ** C√°ch Ch∆°i**: `T` [ s·ªë ti·ªÅn ] `X` [ s·ªë ti·ªÅn ]\n"
            f"‚óâ** C√°ch Ch∆°i**: `T MAX` `X MAX`\n\n"
            f"‚óâ V√≠ D·ª•: **T** 10000 & **X** 10000\n\n"
            f"‚óâ** Tr·∫£ th∆∞·ªüng cho ng∆∞·ªùi th·∫Øng *1.95**\n"
            f"‚óâ** Ch·ªâ ƒë∆∞·ª£c c∆∞·ª£c 1 m·∫∑t trong phi√™n**\n"
            f"‚óâ** Min c∆∞·ª£c: 3.000 - Max c∆∞·ª£c: 300.000**\n\n"
            f"‚óâ** B·∫Øt ƒë·∫ßu c∆∞·ª£c th·ªùi gian [ 90s ]**\n"
            f"üòò **M·ªùi c√°c ƒë·∫°i gia ra tay c∆∞·ª£c m·∫°nh nh√© !**\n",
            parse_mode='Markdown'
        )
    except ApiException as e:
        print(f"L·ªói g·ª≠i tin nh·∫Øn b·∫Øt ƒë·∫ßu game: {e}")
        return # Tho√°t n·∫øu kh√¥ng g·ª≠i ƒë∆∞·ª£c tin nh·∫Øn

    # Th·ªùi gian ch·ªù v√† c·∫≠p nh·∫≠t t·ªïng c∆∞·ª£c
    time.sleep(30) # 60s c√≤n l·∫°i
    update_bet_summary()

    time.sleep(30) # 30s c√≤n l·∫°i
    update_bet_summary()

    time.sleep(20) # 10s c√≤n l·∫°i
    update_bet_summary()

    time.sleep(10) # H·∫øt th·ªùi gian c∆∞·ª£c
    update_bet_summary(final=True)

    turn_off_group_chat() # T·∫Øt nh·∫≠n c∆∞·ª£c
    accepting_bets = False
    time.sleep(3) # ƒê·ª£i m·ªôt ch√∫t tr∆∞·ªõc khi tung x√∫c x·∫Øc

    try:
        bot2.send_message(
            GAME_ROOM_ID,
            f"**B·∫Øt ƒë·∫ßu tung x√∫c x·∫Øc phi√™n #`{current_session}`**", parse_mode='Markdown')
        time.sleep(2)

        dice_results = []
        for _ in range(3):
            dice_value = send_dice_room_reply(GAME_ROOM_ID)
            if dice_value is None:
                print("Kh√¥ng th·ªÉ l·∫•y gi√° tr·ªã x√∫c x·∫Øc. B·ªè qua phi√™n n√†y.")
                return # Tho√°t n·∫øu kh√¥ng tung ƒë∆∞·ª£c x√∫c x·∫Øc
            dice_results.append(dice_value)
            time.sleep(1) # ƒê·ª£i m·ªôt ch√∫t gi·ªØa m·ªói l·∫ßn tung

        dice_sum = sum(dice_results)
        game_result_type = check_result(dice_sum)
        game_result_text = check_result_text(dice_sum)

        session_results.append(game_result_type)
        if len(session_results) > 10:
            session_results.pop(0) # Gi·ªØ l·∫°i 10 phi√™n g·∫ßn nh·∫•t

        save_session_history_to_file()

        total_bet_T = sum([b['T'] for b in user_bets.values()])
        total_bet_X = sum([b['X'] for b in user_bets.values()])
        
        # G·ª¨I K·∫æT QU·∫¢ RI√äNG CHO ADMIN TR∆Ø·ªöC KHI C√îNG KHAI
        admin_private_message = (
            f"üé≤ **K·∫æT QU·∫¢ RI√äNG CHO ADMIN** üé≤\n"
            f"Phi√™n #`{current_session}`\n"
            f"X√∫c x·∫Øc: {dice_results} (T·ªïng: {dice_sum})\n"
            f"K·∫øt qu·∫£: **{game_result_text}**\n"
            f"Lo·∫°i: {'üîµ T√†i' if game_result_type == 'T' else 'üî¥ X·ªâu'}\n"
            f"----------------------------------------\n"
            f"T·ªïng c∆∞·ª£c T√†i: {int(total_bet_T):,} VNƒê\n"
            f"T·ªïng c∆∞·ª£c X·ªâu: {int(total_bet_X):,} VNƒê\n"
        )
        bot.send_message(ADMIN_ID, admin_private_message, parse_mode='Markdown')
        time.sleep(2) # ƒê·ª£i m·ªôt ch√∫t tr∆∞·ªõc khi c√¥ng khai

        send_game_result_and_process_winnings(dice_results, dice_sum, game_result_type)

    except Exception as e:
        print(f"L·ªói trong qu√° tr√¨nh ch·∫°y game: {e}")
        traceback.print_exc()

def update_bet_summary(final=False):
    """C·∫≠p nh·∫≠t v√† g·ª≠i t·ªïng c∆∞·ª£c hi·ªán t·∫°i"""
    total_bet_T = sum([user_bets[user_id]['T'] for user_id in user_bets if 'T' in user_bets[user_id]])
    total_bet_X = sum([user_bets[user_id]['X'] for user_id in user_bets if 'X' in user_bets[user_id]])
    total_bet_TAI_users = sum([1 for user_id in user_bets if user_bets[user_id]['T'] > 0])
    total_bet_XIU_users = sum([1 for user_id in user_bets if user_bets[user_id]['X'] > 0])

    time_remaining_str = ""
    if not final:
        if accepting_bets: # Ki·ªÉm tra accepting_bets ƒë·ªÉ tr√°nh l·ªói n·∫øu h√†m ƒë∆∞·ª£c g·ªçi sau khi ƒë√£ t·∫Øt
             # Th·ªùi gian n√†y ch·ªâ l√† ∆∞·ªõc l∆∞·ª£ng, kh√¥ng ch√≠nh x√°c theo th·ªùi gian th·ª±c c·ªßa phi√™n game
            time_remaining_str = "**‚è∞ C√≤n xx gi√¢y ƒë·ªÉ c∆∞·ª£c phi√™n #`{current_session}`**\n" # C·∫≠p nh·∫≠t th·ªß c√¥ng ho·∫∑c t√≠nh to√°n ch√≠nh x√°c h∆°n n·∫øu c√≥ ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c
    else:
        time_remaining_str = f"**‚è∞ H·∫øt th·ªùi gian phi√™n #[`{current_session}`]**\n"

    try:
        bot2.send_message(
            GAME_ROOM_ID,
            (
                time_remaining_str +
                f"<blockquote>T·ªïng C∆∞·ª£c üîµ | T·ªïng C∆∞·ª£c üî¥</blockquote>\n"
                f"**üîµ T√ÄI: `{int(total_bet_T):,}`**\n"
                f"\n"
                f"**üî¥ X·ªàU: `{int(total_bet_X):,}`**\n\n"
                f"<blockquote>S·ªë Ng∆∞·ªùi C∆∞·ª£c T√ÄI -- X·ªàU</blockquote>\n"
                f"**üëÅ‚Äçüó® T√ÄI: `{int(total_bet_TAI_users):,}` Ng∆∞·ªùi c∆∞·ª£c.**\n"
                f"\n"
                f"**üëÅ‚Äçüó® X·ªàN: `{int(total_bet_XIU_users):,}` Ng∆∞·ªùi c∆∞·ª£c.**\n\n"
            ),
            parse_mode='Markdown'
        )
    except ApiException as e:
        print(f"L·ªói g·ª≠i tin nh·∫Øn t·ªïng c∆∞·ª£c: {e}")

def send_game_result_and_process_winnings(dice_results, dice_sum, game_result_type):
    """G·ª≠i k·∫øt qu·∫£ game v√† x·ª≠ l√Ω ti·ªÅn th·∫Øng/thua"""
    global current_session, user_balance, user_bets, processed_users
    
    last_10_sessions = session_results[-10:]
    display_last_10 = " ".join(
        ["üîµ" if session == 'T' else "üî¥" for session in last_10_sessions])
    last_1_session_display = "üîµ" if game_result_type == 'T' else "üî¥"
    game_result_text = check_result_text(dice_sum)

    total_winnings = 0
    total_losses = 0
    user_winnings_dict = {}

    users_to_process = list(user_bets.keys()) # L·∫•y danh s√°ch ng∆∞·ªùi d√πng ƒë√£ c∆∞·ª£c trong phi√™n
    
    # X·ª≠ l√Ω th·∫Øng/thua cho t·ª´ng ng∆∞·ªùi ch∆°i
    for user_id in users_to_process:
        if user_id not in processed_users: # ƒê·∫£m b·∫£o ch·ªâ x·ª≠ l√Ω m·ªôt l·∫ßn
            user_win_amount = calculate_user_winnings(user_id, game_result_type)
            user_lose_amount = calculate_user_losses(user_id, game_result_type)
            
            total_winnings += user_win_amount
            total_losses += user_lose_amount
            processed_users.add(user_id) # ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω
            
            if user_win_amount > 0:
                user_winnings_dict[user_id] = user_win_amount
            
            # G·ª≠i th√¥ng b√°o ri√™ng cho t·ª´ng ng∆∞·ªùi ch∆°i
            balance = user_balance.get(user_id, 0)
            message_text = ""
            if user_win_amount > 0:
                message_text = (
                    f"üîπÔ∏è Phi√™n XX#`{current_session}` B·∫°n ƒê√£ Th·∫Øng\n"
                    f"S·ªë ti·ªÅn th·∫Øng: **{int(user_win_amount):,}**\n"
                    f"S·ªë d∆∞ m·ªõi: **{int(balance):,}**"
                )
            elif user_lose_amount > 0:
                message_text = (
                    f"üîπÔ∏è Phi√™n XX#`{current_session}` B·∫°n ƒê√£ Thua\n"
                    f"S·ªë ti·ªÅn thua: **{int(user_lose_amount):,}**\n"
                    f"S·ªë d∆∞ m·ªõi: **{int(balance):,}**"
                )
            else: # Kh√¥ng th·∫Øng kh√¥ng thua (v√≠ d·ª• kh√¥ng c∆∞·ª£c ho·∫∑c c∆∞·ª£c h√≤a)
                continue 

            try:
                bot.send_message(chat_id=user_id, text=message_text, parse_mode='Markdown')
            except ApiException as e:
                print(f"Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn k·∫øt qu·∫£ cho ng∆∞·ªùi d√πng {user_id}: {e}")
            except Exception as e:
                print(f"L·ªói khi g·ª≠i tin nh·∫Øn k·∫øt qu·∫£ cho {user_id}: {e}")

    save_balance_to_file() # L∆∞u l·∫°i s·ªë d∆∞ sau khi c·∫≠p nh·∫≠t t·∫•t c·∫£

    sorted_user_winnings = sorted(user_winnings_dict.items(), key=lambda x: x[1], reverse=True)

    leaderboard_message = ""
    if sorted_user_winnings:
        leaderboard_message = "\n".join([
            f"‚îÉ{i+1} - `{str(uid)[-4:]}` - `{int(winnings):,}`"
            for i, (uid, winnings) in enumerate(sorted_user_winnings[:10])
        ])
    else:
        leaderboard_message = "‚îÉ Kh√¥ng c√≥ ng∆∞·ªùi th·∫Øng trong phi√™n n√†y."

    time.sleep(4)
    keyboard = types.InlineKeyboardMarkup()
    # Thay ƒë·ªïi URL n√†y n·∫øu b·∫°n c√≥ k√™nh k·∫øt qu·∫£ ri√™ng
    url_button = types.InlineKeyboardButton(text="K·∫øt Qu·∫£ TX [ Room ]", url="https://t.me/kqtxroomluxury") 
    keyboard.add(url_button)
    
    result_message_to_group = (
        f"**üå∏ K·∫øt Qu·∫£ X√∫c X·∫Øc Phi√™n #`{current_session}`\n"
        f"‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n"
        f"‚îÉ  {' '.join(map(str, dice_results))}  ({dice_sum})  {game_result_text} {last_1_session_display}\n"
        f"‚îÉ\n"
        f"‚îÉ üîé T·ªïng Th·∫Øng: `{int(total_winnings):,}`\n"
        f"‚îÉ\n"
        f"‚îÉ üîé T·ªïng Thua: `{int(total_losses):,}`\n"
        f"‚îÉ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"‚îÉ üèÜ Top B·∫£ng X·∫øp H·∫°ng #[`{current_session}`]\n"
        f"‚îÉ TOP - ID - T·ªïng th·∫Øng\n"
        f"{leaderboard_message}\n"
        f"‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n"
        f"L·ªãch S·ª≠ Phi√™n G·∫ßn Nh·∫•t\n\n"
        f"{display_last_10}\n\n"
        f"      üîµ  T√†i       |      üî¥   X·ªàU\n**"
    )

    try:
        bot2.send_message(
            GAME_ROOM_ID,
            result_message_to_group,
            parse_mode='Markdown',
            reply_markup=keyboard
        )
    except ApiException as e:
        print(f"L·ªói g·ª≠i tin nh·∫Øn k·∫øt qu·∫£ ƒë·∫øn nh√≥m game: {e}")

    # G·ª≠i k·∫øt qu·∫£ c√¥ng khai ra nh√≥m k·∫øt qu·∫£ n·∫øu c√≥
    if RESULT_CHANNEL_ID and RESULT_CHANNEL_ID != GAME_ROOM_ID:
        try:
            bot3.send_message(RESULT_CHANNEL_ID, result_message_to_group, parse_mode='Markdown', reply_markup=keyboard)
        except ApiException as e:
            print(f"L·ªói g·ª≠i tin nh·∫Øn k·∫øt qu·∫£ ƒë·∫øn k√™nh k·∫øt qu·∫£: {e}")

    # user_bets.clear() # X√≥a c∆∞·ª£c c·ªßa phi√™n hi·ªán t·∫°i - ƒë√£ ƒë∆∞·ª£c clear ·ªü ƒë·∫ßu start_game()
    # processed_users.clear() # ƒê√£ ƒë∆∞·ª£c clear ·ªü ƒë·∫ßu start_game()
    time.sleep(3)

def game_timer():
    """Lu·ªìng ch·∫°y game T√†i X·ªâu t·ª± ƒë·ªông"""
    while True:
        try:
            start_game()
        except Exception as e:
            print(f"L·ªói x·∫£y ra trong lu·ªìng game_timer: {e}")
            traceback.print_exc()
        time.sleep(5) # Kho·∫£ng th·ªùi gian ch·ªù gi·ªØa c√°c phi√™n

# =====================--------------(L·ªánh Admin)--------------=====================

@bot.message_handler(commands=['congtien'])
def congtien(message):
    """L·ªánh admin ƒë·ªÉ c·ªông ti·ªÅn cho ng∆∞·ªùi ch∆°i"""
    if message.from_user.id != ADMIN_ID:
        bot.reply_to(message, "‚ö†Ô∏è B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.")
        return

    try:
        command_parts = message.text.split()
        if len(command_parts) != 3:
            bot.reply_to(message, "‚ö†Ô∏è C√∫ ph√°p kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒë√∫ng: `/congtien [ID ng∆∞·ªùi ch∆°i] [s·ªë ti·ªÅn]`", parse_mode='Markdown')
            return

        target_user_id = int(command_parts[1])
        amount = int(command_parts[2])

        if amount <= 0:
            bot.reply_to(message, "‚ö†Ô∏è S·ªë ti·ªÅn c·ªông ph·∫£i l·ªõn h∆°n 0.")
            return

        load_balance_from_file() # T·∫£i s·ªë d∆∞ m·ªõi nh·∫•t

        if target_user_id not in user_balance:
            user_balance[target_user_id] = 0
        user_balance[target_user_id] += amount

        save_balance_to_file() # L∆∞u s·ªë d∆∞ ƒë√£ c·∫≠p nh·∫≠t

        bot.reply_to(message, f"‚úÖ ƒê√£ c·ªông th√†nh c√¥ng **{amount:,} VNƒê** v√†o t√†i kho·∫£n c·ªßa ID **{target_user_id}**.", parse_mode='Markdown')
        
        new_balance = user_balance[target_user_id]
        try:
            bot.send_message(
                target_user_id, 
                f"üéâ **B·∫°n v·ª´a ƒë∆∞·ª£c c·ªông {amount:,} VNƒê v√†o t√†i kho·∫£n.\nS·ªë d∆∞ hi·ªán t·∫°i c·ªßa b·∫°n: {new_balance:,} VNƒê**", 
                parse_mode='Markdown'
            )
        except ApiException as e:
            print(f"Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi d√πng {target_user_id} (c√≥ th·ªÉ do ng∆∞·ªùi d√πng ch·∫∑n bot): {e}")
            bot.reply_to(message, f"‚ö†Ô∏è ƒê√£ c·ªông ti·ªÅn nh∆∞ng kh√¥ng th·ªÉ g·ª≠i th√¥ng b√°o cho ng∆∞·ªùi d√πng {target_user_id} (c√≥ th·ªÉ do ng∆∞·ªùi d√πng ch·∫∑n bot).")
        except Exception as e:
            print(f"L·ªói kh√¥ng x√°c ƒë·ªãnh khi g·ª≠i tin nh·∫Øn cho ng∆∞·ªùi d√πng {target_user_id}: {e}")
            bot.reply_to(message, f"‚ö†Ô∏è ƒê√£ c·ªông ti·ªÅn nh∆∞ng g·∫∑p l·ªói khi g·ª≠i th√¥ng b√°o cho ng∆∞·ªùi d√πng {target_user_id}.")


    except ValueError:
        bot.reply_to(message, "‚ö†Ô∏è S·ªë ID ng∆∞·ªùi ch∆°i ho·∫∑c s·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë nguy√™n.")
    except Exception as e:
        bot.reply_to(message, f"‚ö†Ô∏è ƒê√£ x·∫£y ra l·ªói: {str(e)}")
        traceback.print_exc()

# =====================--------------(X·ª≠ l√Ω tin nh·∫Øn trong nh√≥m game)--------------=====================

@bot2.message_handler(func=lambda message: True)
def handle_message_in_gameroom(message):
    """X·ª≠ l√Ω tin nh·∫Øn trong nh√≥m game (ch·ªß y·∫øu l√† ƒë·∫∑t c∆∞·ª£c)"""
    # Ch·ªâ x·ª≠ l√Ω tin nh·∫Øn trong nh√≥m game ƒë√£ ƒë·ªãnh c·∫•u h√¨nh
    if message.chat.id != GAME_ROOM_ID:
        return

    # Lu√¥n c·ªë g·∫Øng x√≥a tin nh·∫Øn kh√¥ng ph·∫£i l·ªánh c∆∞·ª£c ngay l·∫≠p t·ª©c
    # ƒêi·ªÅu n√†y gi√∫p gi·ªØ cho cu·ªôc tr√≤ chuy·ªán s·∫°ch s·∫Ω
    if not accepting_bets:
        try:
            bot2.delete_message(message.chat.id, message.message_id)
            # Th√™m ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ tr√°nh b·ªã gi·ªõi h·∫°n t·ªëc ƒë·ªô API
            time.sleep(0.1) 
            return # D·ª´ng x·ª≠ l√Ω n·∫øu kh√¥ng ch·∫•p nh·∫≠n c∆∞·ª£c
        except ApiException as e:
            # L·ªói 400 Bad Request th∆∞·ªùng do tin nh·∫Øn ƒë√£ b·ªã x√≥a ho·∫∑c kh√¥ng t·ªìn t·∫°i
            if "Bad Request: message to delete not found" in str(e):
                pass
            else:
                print(f"L·ªói khi x√≥a tin nh·∫Øn khi h·∫øt th·ªùi gian c∆∞·ª£c: {e}")
        except Exception as e:
            print(f"L·ªói kh√¥ng x√°c ƒë·ªãnh khi x√≥a tin nh·∫Øn: {e}")
        return # D·ª´ng x·ª≠ l√Ω n·∫øu kh√¥ng ch·∫•p nh·∫≠n c∆∞·ª£c

    # N·∫øu ƒëang ch·∫•p nh·∫≠n c∆∞·ª£c
    if message.text:
        command_parts = message.text.split()
        if len(command_parts) == 2:
            bet_type = command_parts[0].upper()
            bet_amount_str = command_parts[1]

            if bet_type in ['T', 'X']:
                user_id = message.from_user.id
                
                load_balance_from_file() # T·∫£i s·ªë d∆∞ m·ªõi nh·∫•t

                try:
                    if bet_amount_str.upper() == 'MAX':
                        # C∆∞·ª£c t·ªëi ƒëa l√† s·ªë d∆∞ hi·ªán c√≥ ho·∫∑c 300.000, l·∫•y gi√° tr·ªã nh·ªè h∆°n
                        max_possible_bet = min(user_balance.get(user_id, 0), 300000)
                        if max_possible_bet >= 3000:
                            bet_amount = max_possible_bet
                        else:
                            bot2.send_message(GAME_ROOM_ID, "‚ùå S·ªë d∆∞ c·ªßa b·∫°n kh√¥ng ƒë·ªß ƒë·ªÉ c∆∞·ª£c t·ªëi thi·ªÉu (3.000 VNƒê).", reply_to_message_id=message.message_id)
                            return
                    else:
                        bet_amount = int(bet_amount_str)

                    if 3000 <= bet_amount <= 300000:
                        confirm_bet(user_id, bet_type, bet_amount, message.message_id, is_anonymous=False)
                    else:
                        bot2.send_message(GAME_ROOM_ID, "‚ùå S·ªë ti·ªÅn c∆∞·ª£c ph·∫£i t·ª´ 3.000 ƒë·∫øn 300.000.", reply_to_message_id=message.message_id)
                except ValueError:
                    bot2.send_message(GAME_ROOM_ID, "‚ùå S·ªë ti·ªÅn c∆∞·ª£c kh√¥ng h·ª£p l·ªá.", reply_to_message_id=message.message_id)
                except ApiException as e:
                    print(f"L·ªói API Telegram khi x·ª≠ l√Ω c∆∞·ª£c: {e}")
                except Exception as e:
                    print(f"L·ªói kh√¥ng x√°c ƒë·ªãnh khi x·ª≠ l√Ω c∆∞·ª£c: {e}")
            else:
                # X√≥a tin nh·∫Øn kh√¥ng ph·∫£i l·ªánh T/X nh∆∞ng v·∫´n trong l√∫c nh·∫≠n c∆∞·ª£c
                try:
                    bot2.delete_message(message.chat.id, message.message_id)
                    time.sleep(0.1)
                except ApiException as e:
                    if "Bad Request: message to delete not found" in str(e):
                        pass
                    else:
                        print(f"L·ªói khi x√≥a tin nh·∫Øn kh√¥ng h·ª£p l·ªá: {e}")
        else:
            # X√≥a tin nh·∫Øn kh√¥ng ph·∫£i l·ªánh c∆∞·ª£c h·ª£p l·ªá (v√≠ d·ª•: qu√° nhi·ªÅu t·ª´)
            try:
                bot2.delete_message(message.chat.id, message.message_id)
                time.sleep(0.1)
            except ApiException as e:
                if "Bad Request: message to delete not found" in str(e):
                    pass
                else:
                    print(f"L·ªói khi x√≥a tin nh·∫Øn kh√¥ng h·ª£p l·ªá: {e}")
    else:
        # X√≥a tin nh·∫Øn kh√¥ng c√≥ text (v√≠ d·ª•: ·∫£nh, sticker) trong l√∫c nh·∫≠n c∆∞·ª£c
        try:
            bot2.delete_message(message.chat.id, message.message_id)
            time.sleep(0.1)
        except ApiException as e:
            if "Bad Request: message to delete not found" in str(e):
                pass
            else:
                print(f"L·ªói khi x√≥a tin nh·∫Øn kh√¥ng h·ª£p l·ªá: {e}")


# =====================--------------(Ki·ªÉm tra file)--------------=====================
def check_file():
    """Ki·ªÉm tra s·ª± t·ªìn t·∫°i v√† n·ªôi dung c·ªßa file thanhtran309.txt"""
    try:
        if not os.path.exists("thanhtran309.txt"):
            print("L·ªói: 'thanhtran309.txt' kh√¥ng t√¨m th·∫•y. Bot s·∫Ω kh√¥ng ch·∫°y.")
            return False
        
        with open("thanhtran309.txt", "r") as file:
            content = file.read()
            if "TRANTIENTHANH" not in content:
                print("L·ªói: 'thanhtran309.txt' thi·∫øu chu·ªói 'TRANTIENTHANH'. Bot s·∫Ω kh√¥ng ch·∫°y.")
                return False
    except Exception as e:
        print(f"L·ªói khi ki·ªÉm tra file 'thanhtran309.txt': {e}. Bot s·∫Ω kh√¥ng ch·∫°y.")
        return False
    return True   

# =====================--------------(Kh·ªüi ch·∫°y Bot)--------------=====================
def poll_bot(bot_instance):
    """H√†m ƒë·ªÉ ch·∫°y polling cho t·ª´ng bot trong m·ªôt lu·ªìng ri√™ng"""
    try:
        bot_info = bot_instance.get_me()
        print(f"ƒêang kh·ªüi ƒë·ªông bot: @{bot_info.username}")
        bot_instance.polling(none_stop=True, interval=0, timeout=30)
    except Exception as e:
        print(f"L·ªói khi polling bot: {e}. Th·ª≠ l·∫°i sau 5 gi√¢y...")
        time.sleep(5) # ƒê·ª£i tr∆∞·ªõc khi th·ª≠ l·∫°i
        poll_bot(bot_instance) # G·ªçi l·∫°i ch√≠nh n√≥ ƒë·ªÉ th·ª≠ l·∫°i

if check_file():
    # Kh·ªüi t·∫°o v√† ch·∫°y c√°c lu·ªìng cho t·ª´ng bot
    # ƒê·∫£m b·∫£o m·ªói bot ƒë∆∞·ª£c polling tr√™n m·ªôt lu·ªìng ri√™ng
    threading.Thread(target=poll_bot, args=(bot,)).start()
    threading.Thread(target=poll_bot, args=(bot2,)).start()
    threading.Thread(target=poll_bot, args=(bot3,)).start()

    # Kh·ªüi ch·∫°y lu·ªìng game timer
    timer_thread = threading.Thread(target=game_timer)
    timer_thread.daemon = True # ƒê·∫∑t daemon True ƒë·ªÉ lu·ªìng n√†y t·ª± k·∫øt th√∫c khi ch∆∞∆°ng tr√¨nh ch√≠nh k·∫øt th√∫c
    timer_thread.start()
    print("Bot ƒë√£ kh·ªüi ƒë·ªông v√† ƒëang ch·∫°y...")
else:
    print("Bot kh√¥ng th·ªÉ kh·ªüi ƒë·ªông do l·ªói ki·ªÉm tra file.")

